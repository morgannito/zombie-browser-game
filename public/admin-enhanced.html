<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enhanced Admin Dashboard - Zombie Game</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #0a0e27;
      color: #fff;
      padding: 20px;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 10px;
    }

    h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .tabs {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .tab-btn {
      background: #1a1f3a;
      border: 2px solid #2d3561;
      padding: 12px 25px;
      border-radius: 8px;
      color: #fff;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }

    .tab-btn:hover {
      background: #2d3561;
    }

    .tab-btn.active {
      background: #667eea;
      border-color: #667eea;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .card {
      background: #1a1f3a;
      border-radius: 10px;
      padding: 20px;
      border: 1px solid #2d3561;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
    }

    .card-title {
      font-size: 1.2em;
      font-weight: bold;
      color: #667eea;
    }

    .metric {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #2d3561;
    }

    .metric:last-child {
      border-bottom: none;
    }

    .metric-label {
      color: #94a3b8;
    }

    .metric-value {
      font-weight: bold;
      font-size: 1.1em;
    }

    .metric-value.good { color: #10b981; }
    .metric-value.warning { color: #f59e0b; }
    .metric-value.danger { color: #ef4444; }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s;
      margin: 5px;
    }

    .btn:hover { transform: scale(1.05); }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .player-list {
      list-style: none;
      max-height: 400px;
      overflow-y: auto;
    }

    .player-item {
      background: #0a0e27;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .player-info {
      flex: 1;
    }

    .player-actions {
      display: flex;
      gap: 5px;
    }

    input, select {
      background: #0a0e27;
      border: 1px solid #2d3561;
      padding: 10px;
      border-radius: 5px;
      color: #fff;
      width: 100%;
      margin-bottom: 10px;
    }

    .chart {
      background: #0a0e27;
      padding: 20px;
      border-radius: 10px;
      min-height: 300px;
    }

    .loading {
      text-align: center;
      padding: 50px;
      font-size: 1.5em;
      color: #667eea;
    }

    .error {
      text-align: center;
      padding: 50px;
      font-size: 1.5em;
      color: #ef4444;
      background: #1a1f3a;
      border-radius: 10px;
      border: 2px solid #ef4444;
    }

    .balance-control {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üéÆ Enhanced Admin Dashboard</h1>
      <p id="server-status">Loading...</p>
    </header>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('overview')">Overview</button>
      <button class="tab-btn" onclick="switchTab('players')">Players</button>
      <button class="tab-btn" onclick="switchTab('analytics')">Analytics</button>
      <button class="tab-btn" onclick="switchTab('balance')">Balance</button>
      <button class="tab-btn" onclick="switchTab('moderation')">Moderation</button>
    </div>

    <div id="loading" class="loading pulse">Chargement...</div>
    <div id="error" class="error" style="display: none;">‚ùå Erreur de connexion</div>

    <!-- OVERVIEW TAB -->
    <div id="tab-overview" class="tab-content active">
      <div class="grid">
        <div class="card">
          <div class="card-header">
            <div class="card-title">üéÆ Game State</div>
          </div>
          <div class="metric">
            <span class="metric-label">Players Online</span>
            <span class="metric-value" id="players-current">-</span>
          </div>
          <div class="metric">
            <span class="metric-label">Peak Players</span>
            <span class="metric-value" id="players-peak">-</span>
          </div>
          <div class="metric">
            <span class="metric-label">Active Zombies</span>
            <span class="metric-value" id="zombies-current">-</span>
          </div>
          <div class="metric">
            <span class="metric-label">Current Wave</span>
            <span class="metric-value" id="wave-current">-</span>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">‚ö° Performance</div>
          </div>
          <div class="metric">
            <span class="metric-label">Mode</span>
            <span class="metric-value" id="perf-mode">-</span>
          </div>
          <div class="metric">
            <span class="metric-label">Server FPS</span>
            <span class="metric-value" id="fps">-</span>
          </div>
          <div class="metric">
            <span class="metric-label">Avg Frame Time</span>
            <span class="metric-value" id="frame-avg">-</span>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">üíª System Resources</div>
          </div>
          <div class="metric">
            <span class="metric-label">Heap Memory</span>
            <span class="metric-value" id="mem-heap">-</span>
          </div>
          <div class="metric">
            <span class="metric-label">CPU Load</span>
            <span class="metric-value" id="cpu-load">-</span>
          </div>
          <div class="metric">
            <span class="metric-label">Uptime</span>
            <span class="metric-value" id="uptime">-</span>
          </div>
        </div>
      </div>
    </div>

    <!-- PLAYERS TAB -->
    <div id="tab-players" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div class="card-title">üë• Online Players</div>
          <button class="btn btn-success" onclick="refreshPlayers()">Refresh</button>
        </div>
        <ul class="player-list" id="player-list">
          <li class="player-item">Loading...</li>
        </ul>
      </div>
    </div>

    <!-- ANALYTICS TAB -->
    <div id="tab-analytics" class="tab-content">
      <div class="grid">
        <div class="card">
          <div class="card-header">
            <div class="card-title">üìä Top Players (Account Level)</div>
          </div>
          <ul id="top-players-level" style="list-style: none;">Loading...</ul>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">‚≠ê Top Players (Prestige)</div>
          </div>
          <ul id="top-players-prestige" style="list-style: none;">Loading...</ul>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">üìà Server Statistics</div>
        </div>
        <div class="metric">
          <span class="metric-label">Total Players Registered</span>
          <span class="metric-value" id="total-players">-</span>
        </div>
        <div class="metric">
          <span class="metric-label">Zombies Killed (All Time)</span>
          <span class="metric-value" id="total-zombies-killed">-</span>
        </div>
        <div class="metric">
          <span class="metric-label">Total Sessions</span>
          <span class="metric-value" id="total-sessions">-</span>
        </div>
      </div>
    </div>

    <!-- BALANCE TAB -->
    <div id="tab-balance" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div class="card-title">‚öñÔ∏è Game Balance Controls</div>
        </div>
        <p style="color: #94a3b8; margin-bottom: 20px;">
          ‚ö†Ô∏è Balance controls require server restart to take effect
        </p>

        <h3 style="margin: 20px 0 10px 0; color: #667eea;">Zombie Stats</h3>
        <div class="balance-control">
          <label>Normal Zombie HP:</label>
          <input type="number" id="balance-zombie-hp" value="65">
          <button class="btn btn-success" onclick="updateBalance('zombie-hp')">Update</button>
        </div>
        <div class="balance-control">
          <label>Zombie Damage Multiplier:</label>
          <input type="number" step="0.1" id="balance-zombie-dmg" value="1.0">
          <button class="btn btn-success" onclick="updateBalance('zombie-dmg')">Update</button>
        </div>

        <h3 style="margin: 20px 0 10px 0; color: #667eea;">Player Stats</h3>
        <div class="balance-control">
          <label>Starting Health:</label>
          <input type="number" id="balance-player-hp" value="100">
          <button class="btn btn-success" onclick="updateBalance('player-hp')">Update</button>
        </div>
        <div class="balance-control">
          <label>XP Multiplier:</label>
          <input type="number" step="0.1" id="balance-xp-mult" value="1.0">
          <button class="btn btn-success" onclick="updateBalance('xp-mult')">Update</button>
        </div>

        <h3 style="margin: 20px 0 10px 0; color: #667eea;">Economy</h3>
        <div class="balance-control">
          <label>Gold Drop Multiplier:</label>
          <input type="number" step="0.1" id="balance-gold-mult" value="1.0">
          <button class="btn btn-success" onclick="updateBalance('gold-mult')">Update</button>
        </div>
      </div>
    </div>

    <!-- MODERATION TAB -->
    <div id="tab-moderation" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div class="card-title">üî® Moderation Tools</div>
        </div>

        <h3 style="margin: 20px 0 10px 0; color: #667eea;">Ban Player</h3>
        <input type="text" id="ban-player-id" placeholder="Player ID">
        <input type="text" id="ban-reason" placeholder="Reason">
        <select id="ban-duration">
          <option value="3600">1 hour</option>
          <option value="86400">1 day</option>
          <option value="604800">1 week</option>
          <option value="-1">Permanent</option>
        </select>
        <button class="btn btn-danger" onclick="banPlayer()">Ban Player</button>

        <h3 style="margin: 30px 0 10px 0; color: #667eea;">Kick Player</h3>
        <input type="text" id="kick-player-id" placeholder="Player ID">
        <button class="btn btn-danger" onclick="kickPlayer()">Kick Player</button>

        <h3 style="margin: 30px 0 10px 0; color: #667eea;">Broadcast Message</h3>
        <input type="text" id="broadcast-message" placeholder="Message to all players">
        <button class="btn" onclick="broadcastMessage()">Send Broadcast</button>
      </div>
    </div>

    <div class="refresh-info" style="text-align: center; padding: 15px; background: #1a1f3a; border-radius: 10px; color: #94a3b8; margin-top: 20px;">
      üîÑ Auto-refresh every 2 seconds
    </div>
  </div>

  <script>
    let refreshInterval;
    let currentTab = 'overview';

    function switchTab(tabName) {
      currentTab = tabName;
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

      document.getElementById(`tab-${tabName}`).classList.add('active');
      event.target.classList.add('active');

      // Load tab-specific data
      if (tabName === 'players') loadPlayers();
      if (tabName === 'analytics') loadAnalytics();
    }

    async function fetchMetrics() {
      try {
        const response = await fetch('/health');
        if (!response.ok) throw new Error('Server error');

        const data = await response.json();
        updateDashboard(data);

        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'none';
      } catch (error) {
        console.error('Failed to fetch metrics:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
      }
    }

    function updateDashboard(data) {
      document.getElementById('server-status').textContent =
        data.status === 'healthy' ? '‚úÖ Server Operational' : '‚ùå Server Issues';

      document.getElementById('players-current').textContent = data.game.players.current;
      document.getElementById('players-peak').textContent = data.game.players.peak;
      document.getElementById('zombies-current').textContent = data.game.zombies.current;
      document.getElementById('wave-current').textContent = data.game.wave;

      document.getElementById('perf-mode').textContent = data.performanceMode.toUpperCase();

      const fpsEl = document.getElementById('fps');
      const actualFps = data.performance.fps.actual;
      const targetFps = data.performance.fps.target;
      fpsEl.textContent = `${actualFps} / ${targetFps}`;
      fpsEl.className = 'metric-value ' + (actualFps >= targetFps * 0.9 ? 'good' : 'warning');

      document.getElementById('frame-avg').textContent = data.performance.frameTime.avg.toFixed(2) + ' ms';

      const heapMB = parseFloat(data.system.memory.heapUsedMB);
      const heapTotalMB = parseFloat(data.system.memory.heapTotalMB);
      document.getElementById('mem-heap').textContent = `${heapMB.toFixed(0)} / ${heapTotalMB.toFixed(0)} MB`;

      document.getElementById('cpu-load').textContent = data.system.cpu.loadAverage[0].toFixed(2);
      document.getElementById('uptime').textContent = formatUptime(data.uptime);
    }

    function formatUptime(seconds) {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      return `${hours}h ${minutes}m ${secs}s`;
    }

    async function loadPlayers() {
      // Mock for now - would fetch from real API
      const playerList = document.getElementById('player-list');
      playerList.innerHTML = `
        <li class="player-item">
          <div class="player-info">
            <strong>Player 1</strong><br>
            <small>ID: player-001 | Level: 15 | Online: 5min</small>
          </div>
          <div class="player-actions">
            <button class="btn btn-danger" onclick="kickPlayer('player-001')">Kick</button>
          </div>
        </li>
      `;
    }

    async function loadAnalytics() {
      try {
        const levelRes = await fetch('/api/progression/leaderboard/level?limit=5');
        const levelData = await levelRes.json();

        const prestigeRes = await fetch('/api/progression/leaderboard/prestige?limit=5');
        const prestigeData = await prestigeRes.json();

        const levelList = document.getElementById('top-players-level');
        levelList.innerHTML = levelData.data.map(p =>
          `<li style="padding: 10px; background: #0a0e27; margin-bottom: 5px; border-radius: 5px;">
            #${p.rank} ${p.nickname} - Level ${p.accountLevel}
          </li>`
        ).join('');

        const prestigeList = document.getElementById('top-players-prestige');
        prestigeList.innerHTML = prestigeData.data.map(p =>
          `<li style="padding: 10px; background: #0a0e27; margin-bottom: 5px; border-radius: 5px;">
            #${p.rank} ${p.nickname} - Prestige ${p.prestigeLevel}
          </li>`
        ).join('');
      } catch (error) {
        console.error('Failed to load analytics:', error);
      }
    }

    function updateBalance(type) {
      alert(`Balance update for ${type} - This would require server restart`);
    }

    function banPlayer() {
      const playerId = document.getElementById('ban-player-id').value;
      const reason = document.getElementById('ban-reason').value;
      const duration = document.getElementById('ban-duration').value;

      if (!playerId) {
        alert('Player ID required');
        return;
      }

      alert(`Would ban player ${playerId} for ${duration}s - Reason: ${reason}`);
    }

    function kickPlayer(id) {
      const playerId = id || document.getElementById('kick-player-id').value;
      if (!playerId) {
        alert('Player ID required');
        return;
      }
      alert(`Would kick player ${playerId}`);
    }

    function broadcastMessage() {
      const message = document.getElementById('broadcast-message').value;
      if (!message) {
        alert('Message required');
        return;
      }
      alert(`Would broadcast: ${message}`);
    }

    // Initialize
    fetchMetrics();
    refreshInterval = setInterval(fetchMetrics, 2000);
  </script>
</body>
</html>
